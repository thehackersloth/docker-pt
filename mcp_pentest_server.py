#!/usr/bin/env python3
"""
MCP Server for Pentest Platform
Allows Claude Code to interact with and control the pentest platform

Usage:
    pip install mcp anthropic requests
    python mcp_pentest_server.py

Then add to Claude Code's MCP config:
{
    "mcpServers": {
        "pentest": {
            "command": "python",
            "args": ["/path/to/mcp_pentest_server.py"]
        }
    }
}
"""

import json
import requests
import asyncio
from typing import Any
from mcp.server import Server
from mcp.server.stdio import stdio_server
from mcp.types import Tool, TextContent

# Pentest platform API configuration
PLATFORM_URL = "http://localhost:8000"
API_TOKEN = None

server = Server("pentest-platform")


def get_auth_headers():
    """Get authorization headers"""
    if API_TOKEN:
        return {"Authorization": f"Bearer {API_TOKEN}"}
    return {}


def api_call(method: str, endpoint: str, data: dict = None) -> dict:
    """Make API call to pentest platform"""
    url = f"{PLATFORM_URL}{endpoint}"
    headers = {"Content-Type": "application/json", **get_auth_headers()}

    try:
        if method == "GET":
            response = requests.get(url, headers=headers, timeout=30)
        elif method == "POST":
            response = requests.post(url, json=data, headers=headers, timeout=60)
        elif method == "DELETE":
            response = requests.delete(url, headers=headers, timeout=30)
        else:
            return {"error": f"Unknown method: {method}"}

        return response.json()
    except Exception as e:
        return {"error": str(e)}


@server.list_tools()
async def list_tools() -> list[Tool]:
    """List available pentest tools"""
    return [
        Tool(
            name="pentest_login",
            description="Login to the pentest platform and get auth token",
            inputSchema={
                "type": "object",
                "properties": {
                    "username": {"type": "string", "description": "Username"},
                    "password": {"type": "string", "description": "Password"}
                },
                "required": ["username", "password"]
            }
        ),
        Tool(
            name="pentest_start_scan",
            description="Start a new penetration test scan against target(s)",
            inputSchema={
                "type": "object",
                "properties": {
                    "name": {"type": "string", "description": "Scan name"},
                    "targets": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "List of target IPs, hostnames, or CIDR ranges"
                    },
                    "scan_type": {
                        "type": "string",
                        "enum": ["network", "web", "full"],
                        "description": "Type of scan to run"
                    },
                    "full_automation": {
                        "type": "boolean",
                        "description": "Run full automated pentest with exploitation"
                    }
                },
                "required": ["name", "targets"]
            }
        ),
        Tool(
            name="pentest_get_scan_status",
            description="Get the status and progress of a scan",
            inputSchema={
                "type": "object",
                "properties": {
                    "scan_id": {"type": "string", "description": "Scan ID"}
                },
                "required": ["scan_id"]
            }
        ),
        Tool(
            name="pentest_list_scans",
            description="List all scans",
            inputSchema={
                "type": "object",
                "properties": {
                    "status": {
                        "type": "string",
                        "enum": ["pending", "running", "completed", "failed"],
                        "description": "Filter by status"
                    }
                }
            }
        ),
        Tool(
            name="pentest_get_findings",
            description="Get security findings from a scan",
            inputSchema={
                "type": "object",
                "properties": {
                    "scan_id": {"type": "string", "description": "Scan ID"},
                    "severity": {
                        "type": "string",
                        "enum": ["critical", "high", "medium", "low", "info"],
                        "description": "Filter by severity"
                    }
                },
                "required": ["scan_id"]
            }
        ),
        Tool(
            name="pentest_get_credentials",
            description="Get discovered credentials from a scan",
            inputSchema={
                "type": "object",
                "properties": {
                    "scan_id": {"type": "string", "description": "Scan ID"}
                },
                "required": ["scan_id"]
            }
        ),
        Tool(
            name="pentest_run_exploit",
            description="Run a Metasploit exploit against a target",
            inputSchema={
                "type": "object",
                "properties": {
                    "module": {"type": "string", "description": "MSF module path (e.g., exploit/unix/ftp/vsftpd_234_backdoor)"},
                    "target": {"type": "string", "description": "Target IP"},
                    "port": {"type": "integer", "description": "Target port"},
                    "payload": {"type": "string", "description": "Payload to use"},
                    "options": {"type": "object", "description": "Additional module options"}
                },
                "required": ["module", "target"]
            }
        ),
        Tool(
            name="pentest_list_sessions",
            description="List active Metasploit sessions (shells)",
            inputSchema={
                "type": "object",
                "properties": {}
            }
        ),
        Tool(
            name="pentest_session_command",
            description="Execute command in a Metasploit session",
            inputSchema={
                "type": "object",
                "properties": {
                    "session_id": {"type": "string", "description": "Session ID"},
                    "command": {"type": "string", "description": "Command to execute"}
                },
                "required": ["session_id", "command"]
            }
        ),
        Tool(
            name="pentest_generate_report",
            description="Generate a penetration test report",
            inputSchema={
                "type": "object",
                "properties": {
                    "scan_id": {"type": "string", "description": "Scan ID"},
                    "format": {
                        "type": "string",
                        "enum": ["pdf", "html", "json"],
                        "description": "Report format"
                    },
                    "report_type": {
                        "type": "string",
                        "enum": ["executive", "technical", "full"],
                        "description": "Report type"
                    }
                },
                "required": ["scan_id"]
            }
        ),
        Tool(
            name="pentest_health_check",
            description="Check pentest platform health and status",
            inputSchema={
                "type": "object",
                "properties": {}
            }
        ),
        Tool(
            name="pentest_nmap_scan",
            description="Run a direct nmap scan",
            inputSchema={
                "type": "object",
                "properties": {
                    "target": {"type": "string", "description": "Target IP or range"},
                    "ports": {"type": "string", "description": "Port specification (e.g., '22,80,443' or '1-1000')"},
                    "scan_type": {
                        "type": "string",
                        "enum": ["quick", "full", "stealth", "vuln"],
                        "description": "Scan type"
                    }
                },
                "required": ["target"]
            }
        ),
        Tool(
            name="pentest_hydra_attack",
            description="Run Hydra credential brute force attack",
            inputSchema={
                "type": "object",
                "properties": {
                    "target": {"type": "string", "description": "Target IP"},
                    "service": {
                        "type": "string",
                        "enum": ["ssh", "ftp", "telnet", "smb", "rdp", "mysql", "mssql"],
                        "description": "Service to attack"
                    },
                    "port": {"type": "integer", "description": "Port number"},
                    "usernames": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "List of usernames to try"
                    },
                    "passwords": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "List of passwords to try"
                    }
                },
                "required": ["target", "service"]
            }
        )
    ]


@server.call_tool()
async def call_tool(name: str, arguments: dict[str, Any]) -> list[TextContent]:
    """Execute a pentest tool"""
    global API_TOKEN

    result = None

    if name == "pentest_login":
        result = api_call("POST", "/api/v1/auth/login", {
            "username": arguments["username"],
            "password": arguments["password"]
        })
        if "access_token" in result:
            API_TOKEN = result["access_token"]
            result = {"success": True, "message": "Logged in successfully"}

    elif name == "pentest_health_check":
        result = api_call("GET", "/health")

    elif name == "pentest_start_scan":
        params = "?auto_start=true"
        if arguments.get("full_automation"):
            params += "&full_automation=true"

        result = api_call("POST", f"/api/v1/scans{params}", {
            "name": arguments["name"],
            "targets": arguments["targets"],
            "scan_type": arguments.get("scan_type", "network")
        })

    elif name == "pentest_get_scan_status":
        result = api_call("GET", f"/api/v1/scans/{arguments['scan_id']}")

    elif name == "pentest_list_scans":
        endpoint = "/api/v1/scans"
        if arguments.get("status"):
            endpoint += f"?status={arguments['status']}"
        result = api_call("GET", endpoint)

    elif name == "pentest_get_findings":
        endpoint = f"/api/v1/findings?scan_id={arguments['scan_id']}"
        if arguments.get("severity"):
            endpoint += f"&severity={arguments['severity']}"
        result = api_call("GET", endpoint)

    elif name == "pentest_get_credentials":
        result = api_call("GET", f"/api/v1/scans/{arguments['scan_id']}/credentials")

    elif name == "pentest_run_exploit":
        result = api_call("POST", "/api/v1/metasploit/exploit", {
            "module": arguments["module"],
            "target": arguments["target"],
            "port": arguments.get("port"),
            "payload": arguments.get("payload"),
            "options": arguments.get("options", {})
        })

    elif name == "pentest_list_sessions":
        result = api_call("GET", "/api/v1/metasploit/sessions")

    elif name == "pentest_session_command":
        result = api_call("POST", f"/api/v1/metasploit/sessions/{arguments['session_id']}/command", {
            "command": arguments["command"]
        })

    elif name == "pentest_generate_report":
        result = api_call("POST", "/api/v1/reports/generate", {
            "scan_id": arguments["scan_id"],
            "format": arguments.get("format", "pdf"),
            "report_type": arguments.get("report_type", "full")
        })

    elif name == "pentest_nmap_scan":
        result = api_call("POST", "/api/v1/tools/nmap", {
            "target": arguments["target"],
            "ports": arguments.get("ports", "1-1000"),
            "scan_type": arguments.get("scan_type", "quick")
        })

    elif name == "pentest_hydra_attack":
        result = api_call("POST", "/api/v1/tools/hydra", {
            "target": arguments["target"],
            "service": arguments["service"],
            "port": arguments.get("port"),
            "usernames": arguments.get("usernames", ["admin", "root", "user"]),
            "passwords": arguments.get("passwords", ["admin", "password", "123456"])
        })

    else:
        result = {"error": f"Unknown tool: {name}"}

    return [TextContent(type="text", text=json.dumps(result, indent=2))]


async def main():
    """Run the MCP server"""
    async with stdio_server() as (read_stream, write_stream):
        await server.run(read_stream, write_stream, server.create_initialization_options())


if __name__ == "__main__":
    asyncio.run(main())
